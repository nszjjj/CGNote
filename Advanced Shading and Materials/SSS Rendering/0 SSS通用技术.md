# Intro

关于次表面散射的理论首先参考RTR4$^{[1]}$，可以在第九章《基于物理的着色》了解到理论基础。

看 RTR4 很容易理解物理层面的理论基础，就是照射到物体表面的光并非全部被反射，根据材质的不同有一定比例的光会进入介质内部，进入介质内部的光线会被介质吸收，如果没有被完全吸收的话剩余的部分就会再度从物体中折射出来。一些非金属的材质具有低散射和低吸收的特性，这使得进入物体内部的光线里经过多次散射和吸收之后折射出来的比例较为明显能够观察到，这种现象就是次表面散射。

然后提到的局部次表面散射和全局次表面散射，简单来说就是次表面散射出来的光线到入射点是有一定距离的，叫做<mark>进出距离</mark>。一个片元实际上会覆盖场景中几何体的一部分。如果这个部分很大，大到比次表面散射的进出距离还大，此时相当于对于某个 shading point $p$ 来说次表面散射出来的光线依旧贡献在$p$的着色上，所以可以把他的贡献合到该点的漫反射中，这就是局部 SSS。反过来说 shading point $p$ 次表面散射出来的光线位于别的 shading point，那么这就不是局部 SSS 了，因为无法忽视这个距离对其他地方造成的影响，所以就要全局 SSS。

原文有这么一段话：

> $\rho_{ss}$的值在0（光线被全部吸收）到1（没有任何光线被吸收）之间，并且与波长有关，因此$\rho_{ss}$在渲染中被表示为一个RGB向量。

因为不同波长的光在材质中的吸收率和散射率不同。这点很明显，例如在皮肤渲染中，红光比蓝光更容易穿透皮肤并散射，因此红光的 $\rho_{ss}$​ 值通常比蓝光高。实际使用的时候会将光的颜色分解为 RGB 三个通道然后使用 $\rho_{ss}$ 各个通道分别相乘，得到终从表面逃逸的光线能量

另一方面就是模型的选取（还是原文）：

> 如果次表面散射的距离都大于表面的不规则性，那么在模拟次表面散射现象的时候，应该认为表面是平坦的，不会出现逆反射等效应。此时次表面散射对于微表面而言，并不是一个局部现象，因此无法使用微表面理论来进行描述。在这种情况下，应当使用一个光滑表面的漫反射模型。

还是按皮肤举例子，人类皮肤具有复杂的微表面结构，如毛孔、皱纹等。然而，光线在皮肤内部的散射距离通常在几毫米到几厘米之间，远大于这些微表面结构的尺寸。因此，在渲染皮肤时，通常会忽略微表面结构的影响，而使用光滑表面的 SSS 模型。当然这是指次表面散射部分可以化简为光滑模型，而表面反射部分还是使用微表面模型。

关于皮肤的渲染可以参考 GPU Gems 3 第 14 章中讲解用于实时渲染真实皮肤的高级技术的内容。

# BSSDF

# Approx

## Wrap Lighting

环绕光照（Wrap Lighting）是一种用于模拟光线在物体表面散射的技术，尤其在处理人像时，可以柔化阴影边缘，使光线看起来更加自然和均匀。

核心思想是：当光线照射到物体表面时，一部分光会被吸收，一部分光会被反射，还有一部分光会发生散射。散射的光线会“环绕”物体，照亮原本应该处于阴影中的区域，从而柔化阴影边缘。

公式如下：将漫反射项由原本的$I_{diffuse}$调整为$I_{warp}$

$$
I_{diffuse} = k_d·(N·L)\\ \,
\\
I_{warp} = k_d\frac{(N·L)+w}{1+w}
$$

具体实现代码可以参考引用$^{[3]}$的内容。其本质相当于用$N·L$去调整暗部的颜色，即用漫反射光近似次表面散射光。

## Depth Mapping

> 用来模拟吸收的，光穿过材质的距离越远，散射和吸收就越多。

核心思想：用深度图估计光穿过物体的距离（即<mark>物体表面某个方向的厚度</mark>，这个划重点）。在第一个 pass 中从光源视角渲染一个深度图，然后在第二个 pass 中为摄像机可见的每个片元转换到光源的空间，同之前渲染的深度图的深度作差即可得到光源在介质中传播的距离（厚度）。

<img src="file:///D:/CGNote/Advanced%20Shading%20and%20Materials/SSS%20Rendering/img/fig16-03.jpg" title="" alt="深度图与物体厚度" data-align="center">

问题：如果模型不是凸的，可能会出现问题。GPU Gems 说可以使用深度剥离（depth peeling）技术来解决这个问题

---

厚度只是解决了光线吸收的问题，他可以做背面透光，但是次表面散射效果不止由光线吸收构成。不过可以将厚度映射到一维 LUT，对不同厚度呈现的颜色做预计算，其质量完全取决于 LUT 的生成方式。在永劫无间的技术分享$^{[4]}$中则指出可以分为两部分实现：镜面反射 + 体积渲染。原文如下：

> 而水、宝石等材质，可以视为一个可以进行镜面反射的“界面”包裹着一团某种密度的“介质”，界面所产生的镜面反射完全可以使用现有PBR材质的方式处理。因此永劫中透光材质表现的核心任务，就是设计合适的算法描述在不同密度的介质下，光线的漫反射和透射的不同结果。

相当于对内部用体积渲染的方法得到一部分光线效果。

# 预积分方法



# Ref

[1] [《RTR4》Chapter 9 Physically Based Shading 基于物理的着色](https://www.wolai.com/u2A8QGmD86MZdkpRnSfouQ)

[2] [GPU Gems - Chapter 16. Real-Time Approximations to Subsurface Scattering](https://developer.nvidia.com/gpugems/gpugems/part-iii-materials/chapter-16-real-time-approximations-subsurface-scattering)

[3] [《GPU Gems》第16章：对次表面散射的实时近似](https://zhuanlan.zhihu.com/p/606880884)

[4] [zhihu - 《永劫无间》透光材质的渲染：器物之美，终归于心](https://zhuanlan.zhihu.com/p/410516470)

[5] [zhihu - 基于物理着色（四）- 次表面散射](https://zhuanlan.zhihu.com/p/21247702)

[6] [从零开始的预积分次表面散射](https://zhuanlan.zhihu.com/p/444091986)
